<!DOCTYPE html>

<html>
<head>
  <title>PostgresConnector.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="Application.html">
                Application.coffee
              </a>
            
              
              <a class="source" href="Corridor.html">
                Corridor.coffee
              </a>
            
              
              <a class="source" href="api.html">
                api.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="ConfigManager.html">
                ConfigManager.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="Call.html">
                Call.coffee
              </a>
            
              
              <a class="source" href="Event.html">
                Event.coffee
              </a>
            
              
              <a class="source" href="Link.html">
                Link.coffee
              </a>
            
              
              <a class="source" href="Node.html">
                Node.coffee
              </a>
            
              
              <a class="source" href="PostgresConnector.html">
                PostgresConnector.coffee
              </a>
            
              
              <a class="source" href="config.html">
                config.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="RestAPI.html">
                RestAPI.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
              
              <a class="source" href="SocketManager.html">
                SocketManager.coffee
              </a>
            
              
              <a class="source" href="index.html">
                index.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>PostgresConnector.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>pg = <span class="hljs-built_in">require</span> <span class="hljs-string">'pg'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'async'</span>

Call = <span class="hljs-built_in">require</span> <span class="hljs-string">'./Call'</span>
Node = <span class="hljs-built_in">require</span> <span class="hljs-string">'./Node'</span>
Link = <span class="hljs-built_in">require</span> <span class="hljs-string">'./Link'</span>
Event = <span class="hljs-built_in">require</span> <span class="hljs-string">'./Event'</span>

appConfig = <span class="hljs-built_in">require</span> <span class="hljs-string">'../../config'</span>



<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Connector</span></span>
	<span class="hljs-property">@connectionString</span> : <span class="hljs-literal">null</span>
	<span class="hljs-property">@cache</span> : {}

	<span class="hljs-property">@init</span> : <span class="hljs-function"><span class="hljs-params">( config )</span> -&gt;</span>
		
		<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Connector.connectionString?
			Connector.connectionString = <span class="hljs-string">"postgres://<span class="hljs-subst">#{config.user}</span>"</span>
			
			<span class="hljs-keyword">if</span> config.pass?
				Connector.connectionString += <span class="hljs-string">":<span class="hljs-subst">#{config.pass}</span>"</span>

			Connector.connectionString += <span class="hljs-string">"@<span class="hljs-subst">#{config.host}</span>/<span class="hljs-subst">#{config.databaseName}</span>"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Emty cache every 10 minutes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			setInterval <span class="hljs-function">-&gt;</span>
					cache = {}
				, <span class="hljs-number">600</span>
		
		<span class="hljs-keyword">return</span> Connector.PgConnector


	<span class="hljs-property">@getClient</span> : <span class="hljs-function"><span class="hljs-params">(callback)</span>-&gt;</span>
		
		pg.connect Connector.connectionString, <span class="hljs-function"><span class="hljs-params">(err, client, done)</span>-&gt;</span>
			<span class="hljs-keyword">if</span> err?
				<span class="hljs-built_in">console</span>.warn(err)
			<span class="hljs-keyword">else</span>
				callback(client, done)


	<span class="hljs-class"><span class="hljs-keyword">class</span> @<span class="hljs-title">PgConnector</span></span>

		<span class="hljs-property">@getApplications</span> : <span class="hljs-function"><span class="hljs-params">(callback, forceUpdate)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Read from config if data are limited to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> appConfig.limitDataToConfigSpecifiedList <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>
				callback(appConfig.apps <span class="hljs-keyword">or</span> [])
			<span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>read from database if config allows it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				queryText = <span class="hljs-string">"
					SELECT DISTINCT codeapp
					FROM ccol.appli
					ORDER BY codeapp;
				"</span>

				<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Connector.cache.applications? <span class="hljs-keyword">or</span> forceUpdate <span class="hljs-keyword">is</span> <span class="hljs-literal">on</span>
					Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
						query = client.query queryText
						result = []

						query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span>-&gt;</span> result.push row.codeapp

						query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
							callback(result)
							done()
							Connector.cache.applications = result

						query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span> <span class="hljs-built_in">console</span>.log(err)
				<span class="hljs-keyword">else</span>
					callback(Connector.cache.applications)

		<span class="hljs-property">@getCorridors</span> : <span class="hljs-function"><span class="hljs-params">(callback, forceUpdate)</span>-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Read from config if data are limited to it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> appConfig.limitDataToConfigSpecifiedList <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span>
				callback(appConfig.corridors <span class="hljs-keyword">or</span> [])
			<span class="hljs-keyword">else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>read from database if config allows it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				queryText = <span class="hljs-string">"
					SELECT DISTINCT couloir
					FROM ccol.appli
					ORDER BY couloir
					;
				"</span>

				<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Connector.cache.corridors? <span class="hljs-keyword">or</span> forceUpdate <span class="hljs-keyword">is</span> <span class="hljs-literal">on</span>
					Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
						query = client.query queryText
						result = []

						query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span>-&gt;</span> result.push row.couloir

						query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
							callback(result)
							done()
							Connector.cache.corridors = result

						query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span> <span class="hljs-built_in">console</span>.log(err)

				<span class="hljs-keyword">else</span>
					callback(Connector.cache.corridors)

		<span class="hljs-property">@getEvents</span> : <span class="hljs-function"><span class="hljs-params">(callback, forceUpdate)</span>-&gt;</span>
			queryText = <span class="hljs-string">"
				SELECT codeapp, couloir, codetype, start_time, seen, deleted, old_value, value, diff_stddev, type, id
				FROM ccol.metric_events
				GROUP BY start_time, codeapp, couloir, type, codetype, seen, deleted, old_value, value, diff_stddev, type, id
				ORDER BY start_time DESC;
			"</span>
			<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> Connector.cache.events? <span class="hljs-keyword">or</span> forceUpdate <span class="hljs-keyword">is</span> <span class="hljs-literal">on</span>
				Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
					query = client.query queryText
					result = []

					query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span>-&gt;</span> result.push <span class="hljs-keyword">new</span> Event(row)

					query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
						callback(result)
						done()
						Connector.cache.events = result

					query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span> <span class="hljs-built_in">console</span>.log(err)

			<span class="hljs-keyword">else</span>
				callback(Connector.cache.events)
		
		<span class="hljs-property">@setEvent</span> : <span class="hljs-function"><span class="hljs-params">(callback, event)</span> -&gt;</span>

			queryText = <span class="hljs-string">"
				UPDATE ccol.metric_events
				SET seen = $1, deleted = $2
				WHERE id = $3
				;
			"</span>

			
			Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
				query = client.query queryText, [event.seen, event.deleted, event.id]		
		
				query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-params">(result)</span>-&gt;</span>
					
					callback(result.rowCount &gt; <span class="hljs-number">0</span>)				
					<span class="hljs-keyword">delete</span> Connector.cache.events
					done()
		
				query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span>-&gt;</span>
					<span class="hljs-keyword">throw</span> err
			
				



		
		<span class="hljs-property">@getOverviewData</span> : <span class="hljs-function"><span class="hljs-params">(callback, forceUpdate)</span>-&gt;</span>
			queryText = <span class="hljs-string">"
				SELECT mv.codeapp, mv.couloir, mv.codetype, mv.start_time, SUM(mv.value) AS value, ms.sante
				FROM metric_value mv,  metric_stats ms
				WHERE mv.couloir LIKE 'X_%'
				AND mv.couloir = ms.couloir
				AND mv.codeapp = ms.codeapp
				AND mv.start_time &gt;= (
					 SELECT max(start_time) as start_time from metric_stats 
				)
				AND mv.start_time::date = ms.start_time::date
				GROUP by mv.couloir, mv.codeapp, mv.codetype, mv.start_time, ms.sante
				;
			"</span>

			<span class="hljs-keyword">if</span> Connector.cache.overviewData? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> forceUpdate?
				callback(Connector.cache.overviewData)
			<span class="hljs-keyword">else</span>
				Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
					query = client.query(queryText)
					result = []

					query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span>-&gt;</span> result.push(row)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span>-&gt;</span> <span class="hljs-built_in">console</span>.warn(err)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
						groupByApplication(result)
						done()<span class="hljs-function">

				<span class="hljs-title">computeAbsMax</span> = <span class="hljs-params">(array)</span>-&gt;</span>
					max = -Infinity
					absVal = <span class="hljs-number">0</span>

					<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> array
						absVal = Math.abs(item)
						<span class="hljs-keyword">if</span> absVal &gt; max
							max = absVal 

					<span class="hljs-keyword">return</span> max<span class="hljs-function">

				<span class="hljs-title">groupByApplication</span> = <span class="hljs-params">(data)</span>-&gt;</span>
					mapper = {}
					listResult = []
					types = {}

					<span class="hljs-keyword">if</span> data.length &gt; <span class="hljs-number">0</span>
						<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data
							types[item.codetype] = item.codetype

							<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mapper[item.codeapp]?
								mapper[item.codeapp] = item
								item.detailSante = []
								item.types = {}

							<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mapper[item.codeapp].types[item.codetype]?
								typeStat = 
									value : <span class="hljs-number">0</span>
									detailSante : []
									resSante : <span class="hljs-literal">null</span>

								mapper[item.codeapp].types[item.codetype] = typeStat

							mapper[item.codeapp].types[item.codetype].value += parseInt(item.value, <span class="hljs-number">10</span>)
							mapper[item.codeapp].types[item.codetype].detailSante.push(item.sante)
							mapper[item.codeapp].detailSante.push(item.sante)


						<span class="hljs-keyword">for</span> codeapp, item <span class="hljs-keyword">of</span> mapper
							absMax = <span class="hljs-literal">null</span>
							
							<span class="hljs-keyword">for</span> codetype, stats <span class="hljs-keyword">of</span> item.types
								
								mapper[codeapp].types[codetype].resSante = computeAbsMax(stats.detailSante)
								<span class="hljs-keyword">delete</span> mapper[codeapp].types[codetype].detailSante
							
							<span class="hljs-keyword">for</span> codetype, v <span class="hljs-keyword">of</span> types
								<span class="hljs-keyword">if</span> mapper[codeapp].types? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mapper[codeapp].types[codetype]?
									mapper[codeapp].types[codetype] = 
										<span class="hljs-attribute">value</span>: <span class="hljs-number">0</span>
										<span class="hljs-attribute">detailSante</span>: []
										<span class="hljs-attribute">resSante</span>: <span class="hljs-literal">null</span>

							mapper[codeapp].resSante = computeAbsMax(item.detailSante)
							<span class="hljs-keyword">delete</span> mapper[codeapp].detailSante
							
							listResult.push(mapper[codeapp])

						callback(listResult)
						Connector.cache.overviewData = listResult
					

		<span class="hljs-property">@getHistory</span> : <span class="hljs-function"><span class="hljs-params">(callback, forceUpdate, options)</span>-&gt;</span>

			<span class="hljs-keyword">if</span> options.app <span class="hljs-keyword">is</span> <span class="hljs-string">'all'</span> <span class="hljs-keyword">and</span> options.corridor <span class="hljs-keyword">is</span> <span class="hljs-string">'all'</span>
				options.app = <span class="hljs-string">'%'</span>
				options.corridor = <span class="hljs-string">'%'</span>

			<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> options.limit?
				options.limit = <span class="hljs-literal">null</span>

			queryTextRecords =  <span class="hljs-string">" 
					SELECT codeapp, couloir, start_time as startTime, code, codetype, value
					FROM ccol.metric_value
					WHERE code &lt;&gt; 'INCONNUE' 
					AND codetype NOT LIKE 'nb_appelFI' 
					AND codeapp LIKE $1 
					AND couloir LIKE $2 
					ORDER BY startTime ASC
					LIMIT $3
					;
				"</span><span class="hljs-function">

			<span class="hljs-title">getRecords</span> = <span class="hljs-params">(next)</span>-&gt;</span>
				Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
					query = client.query(queryTextRecords, [options.app, options.corridor, options.limit])
					result = []

					query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span>-&gt;</span> result.push(row)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(error)</span>-&gt;</span> <span class="hljs-built_in">console</span>.warn(error)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
						next(<span class="hljs-literal">null</span>, result)
						done()

			queryTextCalls = <span class="hljs-string">"
				SELECT codeapp, couloir, start_time as startTime, code, codetype, value
				FROM ccol.metric_value
				WHERE code &lt;&gt; 'INCONNUE'
				AND codetype LIKE 'nb_transaction_http'
				AND codeapp LIKE $1
				AND couloir LIKE $2
				ORDER BY startTime ASC
				LIMIT $3
				;
			"</span><span class="hljs-function">

			<span class="hljs-title">getCalls</span> = <span class="hljs-params">(next)</span>-&gt;</span>
				Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
					query = client.query(queryTextCalls, [options.app, options.corridor, options.limit])
					result = []

					query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span> -&gt;</span> result.push(row)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(error)</span>-&gt;</span> <span class="hljs-built_in">console</span>.warn(error)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
						next(<span class="hljs-literal">null</span>, result)
						done()


			async.parallel
					<span class="hljs-attribute">reports</span>: getRecords
					<span class="hljs-attribute">calls</span>: getCalls
				, <span class="hljs-function"><span class="hljs-params">(err, result)</span>-&gt;</span>

					callsMapper = {}
					{reports, calls} = result

					<span class="hljs-keyword">for</span> call <span class="hljs-keyword">in</span> calls
						index = call.starttime

						<span class="hljs-keyword">if</span> callsMapper[index]?
							callsMapper[index] += call.value
						<span class="hljs-keyword">else</span>
							callsMapper[index] = call.value

					<span class="hljs-keyword">for</span> report <span class="hljs-keyword">in</span> reports
						index = report.starttime

						<span class="hljs-keyword">if</span> callsMapper[index]?
							report.http = callsMapper[index]

					callback(reports)


		<span class="hljs-property">@getTrend</span> : <span class="hljs-function"><span class="hljs-params">(callback, forceUpdate, options)</span>-&gt;</span>

			queryText = <span class="hljs-string">" 
				SELECT codetype, start_time as starttime, somme, average, stddev, sante
				FROM ccol.metric_stats 
				WHERE codeapp = $1 
				AND couloir = $2
				;
			"</span>

			Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
				query = client.query(queryText, [options.app, options.corridor])
				result = []

				query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span> -&gt;</span> result.push(row)
				query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(error)</span>-&gt;</span> <span class="hljs-built_in">console</span>.warn(error)
				query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
					next(result)
					done()<span class="hljs-function">

			<span class="hljs-title">next</span> = <span class="hljs-params">(result)</span>-&gt;</span>
				mapper = {}

				<span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> result
					key = record.codetype

					formatedRecord =
						<span class="hljs-attribute">somme</span>: record.somme
						<span class="hljs-attribute">average</span>: record.average
						<span class="hljs-attribute">stddev</span>: record.stddev
						<span class="hljs-attribute">starttime</span>: record.starttime

					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> mapper[key]?
						mapper[key] = []

					mapper[key].push(formatedRecord)

				callback(mapper)

		<span class="hljs-property">@getCalls</span> : <span class="hljs-function"><span class="hljs-params">(callback, forceUpdate)</span>-&gt;</span>
			queryText = <span class="hljs-string">"
				SELECT codeapp, code, couloir, sum(value) as value, codetype, extract(epoch FROM date_trunc('day',  start_time))*1000::bigint as starttime
				FROM metric_value
				WHERE codetype LIKE 'nb_appelFI%'
				AND code LIKE '0%'
				GROUP BY codeapp, starttime,  code, couloir, codetype
				ORDER BY starttime
				;
			"</span>

			<span class="hljs-keyword">if</span> Connector.cache.calls? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> forceUpdate?
				callback(Connector.cache.calls)
			<span class="hljs-keyword">else</span>
				Connector.getClient <span class="hljs-function"><span class="hljs-params">(client, done)</span>-&gt;</span>
					query = client.query(queryText)
					result = []

					query.<span class="hljs-literal">on</span> <span class="hljs-string">'row'</span>, <span class="hljs-function"><span class="hljs-params">(row)</span> -&gt;</span> result.push(row)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-params">(error)</span>-&gt;</span> <span class="hljs-built_in">console</span>.warn(error)
					query.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>,<span class="hljs-function"> -&gt;</span>
						next(result)
						done()<span class="hljs-function">

			<span class="hljs-title">next</span> = <span class="hljs-params">(data)</span>-&gt;</span>
				calls = []

				<span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> data

					{codeapp, codetype, code, couloir, value, starttime} = row
					call = <span class="hljs-keyword">new</span> Call(codeapp, codetype, code, couloir, value, starttime)
					calls.push(call)

				createCallTree(calls)<span class="hljs-function">

			<span class="hljs-title">createCallTree</span> = <span class="hljs-params">(calls)</span>-&gt;</span>
				nodes = {}
				links = {}

				<span class="hljs-keyword">for</span> call <span class="hljs-keyword">in</span> calls</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Caller node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					leafName = call.caller
					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nodes[leafName]?
						nodes[leafName] = <span class="hljs-keyword">new</span> Node(leafName, <span class="hljs-string">'Application'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Called node</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					leafName = call.called
					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nodes[leafName]?
						nodes[leafName] = <span class="hljs-keyword">new</span> Node(leafName, <span class="hljs-string">'Application'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Service (of the called node)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					service = call.service					
					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nodes[service]?
						nodes[service] = <span class="hljs-keyword">new</span> Node(service, <span class="hljs-string">'Service'</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Method (of the called node)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					method = <span class="hljs-string">"<span class="hljs-subst">#{call.service}</span>::<span class="hljs-subst">#{call.method}</span>"</span>
					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> nodes[method]?
						nodes[method] = <span class="hljs-keyword">new</span> Node(method, <span class="hljs-string">'Method'</span>, <span class="hljs-number">0</span>)
					<span class="hljs-keyword">else</span>
						nodes[method].add(call.value)</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Now we have nodes, we need to build the links</p>

            </div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>First : app -&gt; other app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					key = <span class="hljs-string">"<span class="hljs-subst">#{call.caller}</span>:<span class="hljs-subst">#{call.called}</span>:<span class="hljs-subst">#{call.starttime}</span>"</span>

					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> links[key]?
						links[key] = <span class="hljs-keyword">new</span> Link(call)
					<span class="hljs-keyword">else</span>
						links[key].add(call.value)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Next :  app-&gt;services</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
					key = <span class="hljs-string">"<span class="hljs-subst">#{call.service}</span>:<span class="hljs-subst">#{call.starttime}</span>"</span>
					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> links[key]?
						links[key] = <span class="hljs-keyword">new</span> Link(call)
						links[key].target = call.service
					<span class="hljs-keyword">else</span>
						links[key].add(call.value)</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Next : service-&gt;method</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
					key = <span class="hljs-string">"<span class="hljs-subst">#{call.service}</span>:<span class="hljs-subst">#{method}</span>:<span class="hljs-subst">#{call.starttime}</span>"</span>

					<span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> links[key]?
						links[key] = <span class="hljs-keyword">new</span> Link(call)
						links[key].source = call.service
						links[key].target = method
					<span class="hljs-keyword">else</span>
						links[key].add(call.value)</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>convert links from object to array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				linksArray = []
				<span class="hljs-keyword">for</span> key, link <span class="hljs-keyword">of</span> links
					linksArray.push(link)
					<span class="hljs-keyword">delete</span> links[key] <span class="hljs-comment"># will help the GC</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>we put all in a single object</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
				mapper =
					<span class="hljs-attribute">nodes</span>: nodes
					<span class="hljs-attribute">links</span>: linksArray

				callback(mapper)
				Connector.cache.calls = mapper


<span class="hljs-built_in">module</span>.exports = Connector.init;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
